---
# PostgreSQL HA StatefulSet with Patroni
# This replaces the single-replica Deployment with a 3-replica HA setup
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-ha
  namespace: 20890-ideaforge-ai-dev-58a50
  labels:
    app: postgres-ha
    component: database
spec:
  serviceName: postgres-ha
  replicas: 3  # 1 primary + 2 replicas
  selector:
    matchLabels:
      app: postgres-ha
  template:
    metadata:
      labels:
        app: postgres-ha
        component: database
    spec:
      containers:
      - name: postgres
        image: pgvector/pgvector:pg15
        ports:
        - containerPort: 5432
          name: postgres
        - containerPort: 8008
          name: patroni-rest-api
        env:
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              name: ideaforge-ai-config
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ideaforge-ai-secrets
              key: POSTGRES_PASSWORD
        - name: POSTGRES_DB
          valueFrom:
            configMapKeyRef:
              name: ideaforge-ai-config
              key: POSTGRES_DB
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        # Patroni configuration
        - name: PATRONI_SCOPE
          value: "postgres-ha"
        - name: PATRONI_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: PATRONI_NAMESPACE
          value: "20890-ideaforge-ai-dev-58a50"
        - name: PATRONI_RESTAPI_LISTEN
          value: "0.0.0.0:8008"
        - name: PATRONI_RESTAPI_CONNECT_ADDRESS
          value: "$(PATRONI_NAME).postgres-ha:8008"
        - name: PATRONI_ETCD_HOSTS
          value: "etcd-0.etcd:2379,etcd-1.etcd:2379,etcd-2.etcd:2379"
        - name: PATRONI_POSTGRESQL_LISTEN
          value: "0.0.0.0:5432"
        - name: PATRONI_POSTGRESQL_CONNECT_ADDRESS
          value: "$(PATRONI_NAME).postgres-ha:5432"
        - name: PATRONI_POSTGRESQL_DATA_DIR
          value: "/var/lib/postgresql/data/pgdata"
        - name: PATRONI_POSTGRESQL_PGPASS
          value: "/tmp/pgpass"
        - name: PATRONI_REPLICATION_USERNAME
          value: "replicator"
        - name: PATRONI_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ideaforge-ai-secrets
              key: POSTGRES_REPLICATION_PASSWORD
        - name: PATRONI_SUPERUSER_USERNAME
          valueFrom:
            configMapKeyRef:
              name: ideaforge-ai-config
              key: POSTGRES_USER
        - name: PATRONI_SUPERUSER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ideaforge-ai-secrets
              key: POSTGRES_PASSWORD
        # PostgreSQL performance tuning (same as before)
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF8 --locale=C"
        command:
        - /bin/bash
        - -c
        - |
          # Create pgpass file for Patroni
          echo "*:*:*:${PATRONI_SUPERUSER_USERNAME}:${PATRONI_SUPERUSER_PASSWORD}" > /tmp/pgpass
          echo "*:*:replication:${PATRONI_REPLICATION_USERNAME}:${PATRONI_REPLICATION_PASSWORD}" >> /tmp/pgpass
          chmod 600 /tmp/pgpass
          
          # Generate Patroni configuration
          cat > /etc/patroni.yml <<EOF
          scope: ${PATRONI_SCOPE}
          namespace: /${PATRONI_SCOPE}
          name: ${PATRONI_NAME}
          
          restapi:
            listen: ${PATRONI_RESTAPI_LISTEN}
            connect_address: ${PATRONI_RESTAPI_CONNECT_ADDRESS}
          
          etcd:
            hosts: ${PATRONI_ETCD_HOSTS}
          
          bootstrap:
            dcs:
              ttl: 30
              loop_wait: 10
              retry_timeout: 30
              maximum_lag_on_failover: 1048576
              postgresql:
                use_pg_rewind: true
                use_slots: true
                parameters:
                  max_connections: 500
                  shared_buffers: 1GB
                  effective_cache_size: 3GB
                  maintenance_work_mem: 256MB
                  checkpoint_completion_target: 0.9
                  wal_buffers: 16MB
                  default_statistics_target: 100
                  random_page_cost: 1.1
                  effective_io_concurrency: 200
                  work_mem: 8MB
                  min_wal_size: 1GB
                  max_wal_size: 4GB
                  max_worker_processes: 4
                  max_parallel_workers_per_gather: 2
                  max_parallel_workers: 4
                  hot_standby: on
                  hot_standby_feedback: on
                  wal_level: replica
                  max_wal_senders: 10
                  max_replication_slots: 10
                  wal_keep_segments: 32
                  archive_mode: on
                  archive_command: 'test ! -f /var/lib/postgresql/data/pg_wal/%f && cp %p /var/lib/postgresql/data/pg_wal/%f'
          
          postgresql:
            listen: ${PATRONI_POSTGRESQL_LISTEN}
            connect_address: ${PATRONI_POSTGRESQL_CONNECT_ADDRESS}
            data_dir: ${PATRONI_POSTGRESQL_DATA_DIR}
            pgpass: ${PATRONI_POSTGRESQL_PGPASS}
            authentication:
              replication:
                username: ${PATRONI_REPLICATION_USERNAME}
                password: ${PATRONI_REPLICATION_PASSWORD}
              superuser:
                username: ${PATRONI_SUPERUSER_USERNAME}
                password: ${PATRONI_SUPERUSER_PASSWORD}
            parameters:
              max_connections: 500
              shared_buffers: 1GB
              effective_cache_size: 3GB
              maintenance_work_mem: 256MB
              checkpoint_completion_target: 0.9
              wal_buffers: 16MB
              default_statistics_target: 100
              random_page_cost: 1.1
              effective_io_concurrency: 200
              work_mem: 8MB
              min_wal_size: 1GB
              max_wal_size: 4GB
              max_worker_processes: 4
              max_parallel_workers_per_gather: 2
              max_parallel_workers: 4
              hot_standby: on
              hot_standby_feedback: on
              wal_level: replica
              max_wal_senders: 10
              max_replication_slots: 10
          EOF
          
          # Start Patroni
          exec patroni /etc/patroni.yml
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /liveness
            port: 8008
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /readiness
            port: 8008
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 5
      initContainers:
      - name: wait-for-etcd
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z etcd-0.etcd 2379 && nc -z etcd-1.etcd 2379 && nc -z etcd-2.etcd 2379; do
            echo "Waiting for etcd cluster..."
            sleep 2
          done
          echo "etcd cluster is ready"
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: default-storage-class
      resources:
        requests:
          storage: 20Gi

---
# Service for PostgreSQL HA - routes to primary
apiVersion: v1
kind: Service
metadata:
  name: postgres-ha
  namespace: 20890-ideaforge-ai-dev-58a50
  labels:
    app: postgres-ha
    component: database
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
    name: postgres
  selector:
    app: postgres-ha
  # Use Patroni REST API to determine primary
  # This will be handled by a sidecar or init script

---
# Service for PostgreSQL HA - read replicas (optional, for read scaling)
apiVersion: v1
kind: Service
metadata:
  name: postgres-ha-replicas
  namespace: 20890-ideaforge-ai-dev-58a50
  labels:
    app: postgres-ha
    component: database
    role: replica
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
    name: postgres
  selector:
    app: postgres-ha
    role: replica

