apiVersion: batch/v1
kind: Job
metadata:
  name: update-migration-tracking
  namespace: 20890-ideaforge-ai-dev-58a50
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready!"
      containers:
      - name: update-tracking
        image: postgres:15-alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "ðŸ”„ Updating migration tracking table..."
          
          # Create schema_migrations table if it doesn't exist
          echo "ðŸ“‹ Creating schema_migrations table..."
          psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c "
            CREATE TABLE IF NOT EXISTS schema_migrations (
              id SERIAL PRIMARY KEY,
              migration_name VARCHAR(255) UNIQUE NOT NULL,
              applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            );
          " 2>&1 | grep -v "NOTICE" || true
          
          # Get list of all migration files from ConfigMap
          MIGRATIONS=$(ls -1 /migrations/*.sql 2>/dev/null | xargs -n1 basename | sort || echo "")
          
          if [ -z "$MIGRATIONS" ]; then
            echo "âš ï¸  No migration files found"
            exit 0
          fi
          
          # Mark all migrations as applied
          for migration in $MIGRATIONS; do
            echo "   Marking migration as applied: $migration"
            psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c "
              INSERT INTO schema_migrations (migration_name)
              VALUES ('$migration')
              ON CONFLICT (migration_name) DO NOTHING;
            " 2>&1 | grep -v "NOTICE" || true
          done
          
          echo "âœ… Migration tracking updated"
          echo "ðŸ“Š Current tracked migrations:"
          psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT migration_name, applied_at FROM schema_migrations ORDER BY applied_at;" 2>&1 | grep -v "NOTICE" || true
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: ideaforge-ai-secrets
              key: POSTGRES_PASSWORD
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              name: ideaforge-ai-config
              key: POSTGRES_USER
        - name: POSTGRES_DB
          valueFrom:
            configMapKeyRef:
              name: ideaforge-ai-config
              key: POSTGRES_DB
        volumeMounts:
        - name: migrations
          mountPath: /migrations
          readOnly: true
      volumes:
      - name: migrations
        configMap:
          name: db-migrations

