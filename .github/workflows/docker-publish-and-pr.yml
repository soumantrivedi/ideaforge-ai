name: Build, Publish Docker Images, and Create PR

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'src/**'
      - 'Dockerfile.*'
      - 'docker-compose.yml'
      - 'Makefile'
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Git SHA
        id: git-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get branch name (sanitized)
        id: branch-name
        run: |
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          if [ -z "$BRANCH_NAME" ] || [ "$BRANCH_NAME" = "head" ]; then
            BRANCH_NAME="main"
          fi
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch name (sanitized): $BRANCH_NAME"

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=sha,format=short,prefix=
            type=raw,value=${{ steps.branch-name.outputs.name }}-${{ steps.git-sha.outputs.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=sha,format=short,prefix=
            type=raw,value=${{ steps.branch-name.outputs.name }}-${{ steps.git-sha.outputs.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Get Version
        id: version
        run: echo "version=${{ steps.git-sha.outputs.sha }}" >> $GITHUB_OUTPUT

      - name: Set frontend build args
        id: frontend-args
        run: |
          VITE_API_URL="${{ secrets.VITE_API_URL }}"
          if [ -z "$VITE_API_URL" ]; then
            VITE_API_URL="http://localhost:8000"
          fi
          echo "vite_api_url=$VITE_API_URL" >> $GITHUB_OUTPUT
          echo "VITE_API_URL set to: $VITE_API_URL"

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          build-args: |
            GIT_SHA=${{ steps.git-sha.outputs.sha }}
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            VITE_API_URL=${{ steps.frontend-args.outputs.vite_api_url }}
            VITE_OKTA_CLIENT_ID=${{ secrets.VITE_OKTA_CLIENT_ID }}
            VITE_OKTA_ISSUER=${{ secrets.VITE_OKTA_ISSUER }}
            GIT_SHA=${{ steps.git-sha.outputs.sha }}
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-and-verify:
    needs: build-and-publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Git SHA
        id: git-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get Version
        id: version
        run: echo "version=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Pull published images
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.git-sha.outputs.sha }} || \
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.git-sha.outputs.sha }} || \
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest

      - name: Tag images for local use
        run: |
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.git-sha.outputs.sha }} ideaforge-ai-backend:${{ steps.git-sha.outputs.sha }} || \
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest ideaforge-ai-backend:${{ steps.git-sha.outputs.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.git-sha.outputs.sha }} ideaforge-ai-frontend:${{ steps.git-sha.outputs.sha }} || \
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest ideaforge-ai-frontend:${{ steps.git-sha.outputs.sha }}

      - name: Start services with docker-compose
        run: |
          GIT_SHA=${{ steps.git-sha.outputs.sha }} VERSION=${{ steps.version.outputs.version }} \
          docker-compose up -d
        env:
          POSTGRES_USER: agentic_pm
          POSTGRES_PASSWORD: devpassword
          POSTGRES_DB: agentic_pm_db
          REDIS_URL: redis://redis:6379
          DATABASE_URL: postgresql://agentic_pm:devpassword@postgres:5432/agentic_pm_db

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker-compose ps | grep -q "healthy"; then
              echo "Services are healthy"
              break
            fi
            sleep 5
            elapsed=$((elapsed + 5))
            echo "Waiting... ($elapsed/$timeout seconds)"
          done
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for services"
            docker-compose ps
            exit 1
          fi

      - name: Check backend health
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
              curl -s http://localhost:8000/health | jq .
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts: Backend not ready yet..."
            sleep 2
          done
          echo "âŒ Backend health check failed"
          exit 1

      - name: Check frontend health
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3001 > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts: Frontend not ready yet..."
            sleep 2
          done
          echo "âŒ Frontend health check failed"
          exit 1

      - name: Check for errors in docker logs
        id: check-logs
        continue-on-error: true
        run: |
          echo "Checking docker logs for errors..."
          
          # Check backend logs
          backend_errors=$(docker-compose logs backend --tail 500 2>&1 | grep -iE "(error|Error|ERROR|exception|Exception|EXCEPTION|traceback|Traceback|TRACEBACK|failed|Failed|FAILED|critical|Critical|CRITICAL|fatal|Fatal|FATAL)" | grep -v "warning" | grep -v "WARNING" | wc -l || echo "0")
          
          # Check frontend logs
          frontend_errors=$(docker-compose logs frontend --tail 500 2>&1 | grep -iE "(error|Error|ERROR|exception|Exception|EXCEPTION|traceback|Traceback|TRACEBACK|failed|Failed|FAILED|critical|Critical|CRITICAL|fatal|Fatal|FATAL)" | grep -v "warning" | grep -v "WARNING" | wc -l || echo "0")
          
          # Check postgres logs
          postgres_errors=$(docker-compose logs postgres --tail 200 2>&1 | grep -iE "(error|Error|ERROR|exception|Exception|EXCEPTION|traceback|Traceback|TRACEBACK|failed|Failed|FAILED|critical|Critical|CRITICAL|fatal|Fatal|FATAL)" | grep -v "warning" | grep -v "WARNING" | wc -l || echo "0")
          
          total_errors=$((backend_errors + frontend_errors + postgres_errors))
          
          echo "Backend errors: $backend_errors"
          echo "Frontend errors: $frontend_errors"
          echo "Postgres errors: $postgres_errors"
          echo "Total errors: $total_errors"
          
          if [ "$total_errors" -gt 0 ]; then
            echo "âŒ Found $total_errors errors in logs"
            echo "error_count=$total_errors" >> $GITHUB_OUTPUT
            echo "has_errors=true" >> $GITHUB_OUTPUT
            
            # Show error details
            echo "=== Backend Errors ==="
            docker-compose logs backend --tail 500 | grep -iE "(error|Error|ERROR|exception|Exception|EXCEPTION|traceback|Traceback|TRACEBACK|failed|Failed|FAILED|critical|Critical|CRITICAL|fatal|Fatal|FATAL)" | grep -v "warning" | grep -v "WARNING" | head -20 || true
            
            echo "=== Frontend Errors ==="
            docker-compose logs frontend --tail 500 | grep -iE "(error|Error|ERROR|exception|Exception|EXCEPTION|traceback|Traceback|TRACEBACK|failed|Failed|FAILED|critical|Critical|CRITICAL|fatal|Fatal|FATAL)" | grep -v "warning" | grep -v "WARNING" | head -20 || true
          else
            echo "âœ… No errors found in logs"
            echo "error_count=0" >> $GITHUB_OUTPUT
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi
          
          # Write to file for next job
          mkdir -p /tmp/error-check
          echo "${{ steps.check-logs.outputs.has_errors }}" > /tmp/error-check/has_errors.txt
          echo "${{ steps.check-logs.outputs.error_count }}" > /tmp/error-check/error_count.txt

      - name: Run database migrations
        run: |
          docker-compose exec -T postgres psql -U agentic_pm -d agentic_pm_db -f /docker-entrypoint-initdb.d/migrations/20251124000003_user_api_keys.sql 2>&1 | grep -v "NOTICE" | grep -v "already exists" || true
          docker-compose exec -T postgres psql -U agentic_pm -d agentic_pm_db -f /docker-entrypoint-initdb.d/migrations/20251124000004_product_scoring.sql 2>&1 | grep -v "NOTICE" | grep -v "already exists" || true
          docker-compose exec -T postgres psql -U agentic_pm -d agentic_pm_db -f /docker-entrypoint-initdb.d/migrations/20251125000001_user_management_tenants.sql 2>&1 | grep -v "NOTICE" | grep -v "already exists" || true

      - name: Upload error check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-check-results
          path: /tmp/error-check
          retention-days: 1

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v

  create-pr:
    needs: [build-and-publish, test-and-verify]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download error check results
        uses: actions/download-artifact@v4
        with:
          name: error-check-results
          path: /tmp/error-check

      - name: Check if errors were found
        id: check-errors
        run: |
          if [ -f /tmp/error-check/has_errors.txt ]; then
            HAS_ERRORS=$(cat /tmp/error-check/has_errors.txt)
            ERROR_COUNT=$(cat /tmp/error-check/error_count.txt || echo "0")
            echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT
            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            if [ "$HAS_ERRORS" = "true" ]; then
              echo "âŒ Errors found in logs ($ERROR_COUNT errors), skipping PR creation"
              exit 1
            else
              echo "âœ… No errors found, proceeding with PR creation"
            fi
          else
            echo "âš ï¸  Error check results not found, proceeding with caution"
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "error_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Get Git SHA
        id: git-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get default branch
        id: default-branch
        run: |
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Default branch: $DEFAULT_BRANCH"

      - name: Create or update branch
        run: |
          BRANCH_NAME="ci/docker-publish-$(date +%Y%m%d-%H%M%S)-${{ steps.git-sha.outputs.sha }}"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, checking it out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi

      - name: Update docker-compose.yml with published images
        run: |
          cat >> docker-compose.ci.yml << EOF
          # CI/CD Published Images
          # Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.git-sha.outputs.sha }}
          # Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.git-sha.outputs.sha }}
          # Published at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Commit changes
        id: commit
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "ci: Publish Docker images and update deployment

          - Published backend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.git-sha.outputs.sha }}
          - Published frontend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.git-sha.outputs.sha }}
          - All services verified and running
          - No errors in docker logs
          - Git SHA: ${{ steps.git-sha.outputs.sha }}
          
          [skip ci]"
            git push origin "$BRANCH_NAME"
            echo "committed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.committed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ CI: Docker Images Published - ${{ steps.git-sha.outputs.sha }}`,
              head: process.env.BRANCH_NAME,
              base: '${{ steps.default-branch.outputs.branch }}',
              body: `## ğŸ³ Docker Images Published

              This PR was automatically created after successfully building, publishing, and verifying Docker images.

              ### ğŸ“¦ Published Images
              - **Backend**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.git-sha.outputs.sha }}\`
              - **Frontend**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.git-sha.outputs.sha }}\`

              ### âœ… Verification Results
              - âœ… All Docker images built successfully
              - âœ… Images pushed to GitHub Container Registry
              - âœ… Services started and healthy
              - âœ… Backend health check passed
              - âœ… Frontend health check passed
              - âœ… No errors found in docker logs
              - âœ… Database migrations completed

              ### ğŸ“ Details
              - **Git SHA**: \`${{ steps.git-sha.outputs.sha }}\`
              - **Workflow Run**: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - **Triggered by**: ${{ github.actor }}

              ### ğŸ” Next Steps
              - Review the changes
              - Merge when ready
              - Images are available in GitHub Container Registry`,
              draft: false
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ci', 'docker', 'automated']
            });

      - name: Output PR URL
        if: steps.commit.outputs.committed == 'true'
        run: |
          echo "Pull Request created successfully!"
          echo "Check the GitHub Actions output for the PR URL"

